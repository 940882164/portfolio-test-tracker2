<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Portfolio Test Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: linear-gradient(135deg,#dbeafe,#eef2ff);
  color: #000;
}

.container {
  max-width: 1400px;
  margin: 30px auto;
  padding: 20px;
}

h1,h2,h3 { color:#1d4ed8; }

.grid-top {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
}

.grid-bottom {
  display: grid;
  grid-template-columns: 3fr 1fr;
  gap: 20px;
  margin-top: 20px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
}

.controls {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin:12px 0;
}

input, select {
  padding:10px;
  border-radius:6px;
  border:1px solid #c7d2fe;
}

button {
  padding:10px 16px;
  border-radius:6px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  color:white;
  background:#2563eb;
}

button.delete { background:#dc2626; }
button.export { background:#16a34a; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th,td {
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:center;
}

th { background:#e0e7ff; }

.status {
  padding:6px 14px;
  border-radius:20px;
  color:white;
  font-weight:bold;
  text-transform:capitalize;
}

.passed { background:#16a34a; }
.failed { background:#dc2626; }
.pending { background:#f59e0b; }
</style>
</head>

<body>
<div class="container">

<h1>Portfolio Test Tracker</h1>

<!-- TOP -->
<div class="grid-top">
  <div class="card">
    <h2>Upload & Project Overview</h2>
    <div class="controls">
      <input type="file" accept=".xlsx" id="excelInput">
      <button class="export" onclick="exportExcel()">Export Excel</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Project</th>
          <th>Passed</th>
          <th>Failed</th>
          <th>Pending</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="summaryTable"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Create Project</h2>
    <div class="controls">
      <input id="projectName" placeholder="Project name">
      <button onclick="createProject()">Create</button>
    </div>
  </div>
</div>

<!-- BOTTOM -->
<div class="grid-bottom">
  <div class="card">
    <h2>Test Case Management</h2>

    <table>
      <thead>
        <tr>
          <th>Project</th>
          <th>ID</th>
          <th>Test Case</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="testCaseTable"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Add Test Case</h2>
    <div class="controls">
      <select id="projectSelect"></select>
      <input id="testCaseName" placeholder="Test case name">
      <select id="testStatus">
        <option value="pending">Pending</option>
        <option value="passed">Passed</option>
        <option value="failed">Failed</option>
      </select>
      <button onclick="addTestCase()">Add</button>
    </div>
  </div>
</div>

</div>

<script>
let projects = JSON.parse(localStorage.getItem("projects") || "{}");

function save() {
  localStorage.setItem("projects", JSON.stringify(projects));
}

/* ---------- EXCEL IMPORT ---------- */
document.getElementById("excelInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    const wb = XLSX.read(new Uint8Array(ev.target.result), { type:"array" });
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:"" });

    projects = {};
    rows.forEach((r,i)=>{
      const p = r.Project || "Default Project";
      const name = r["Test Case"] || `Test ${i+1}`;
      let s = (r.Status || "pending").toLowerCase();
      if (s.includes("pass")) s="passed";
      else if (s.includes("fail")) s="failed";
      else s="pending";

      if (!projects[p]) projects[p]=[];
      projects[p].push({ id: projects[p].length+1, name, status:s });
    });

    save(); render();
  };
  reader.readAsArrayBuffer(file);
});

/* ---------- CRUD ---------- */
function createProject(){
  const n = projectName.value.trim();
  if(!n || projects[n]) return;
  projects[n] = [];
  projectName.value="";
  save(); render();
}

function addTestCase(){
  const p = projectSelect.value;
  const n = testCaseName.value.trim();
  const s = testStatus.value;
  if(!p || !n) return;

  projects[p].push({ id: projects[p].length+1, name:n, status:s });
  testCaseName.value="";
  save(); render();
}

function deleteProject(p){
  if(!confirm(`Delete project "${p}"?`)) return;
  delete projects[p];
  save(); render();
}

function deleteTestCase(p,id){
  projects[p] = projects[p].filter(t=>t.id!==id);
  projects[p].forEach((t,i)=>t.id=i+1);
  save(); render();
}

/* ðŸ”´ THIS IS THE FIX */
function updateTestStatus(project, id, value){
  const tc = projects[project].find(t=>t.id===id);
  if(tc){
    tc.status = value;
    save();
    render();
  }
}

/* ---------- HELPERS ---------- */
function projectStatus(t){
  if(!t.length) return "pending";
  const f=t.filter(x=>x.status==="failed").length;
  const pen=t.filter(x=>x.status==="pending").length;
  if(f===t.length) return "failed";
  if(pen===0) return "passed";
  return "pending";
}

function exportExcel(){
  const data=[];
  Object.entries(projects).forEach(([p,t])=>{
    t.forEach(tc=>data.push({Project:p,"Test Case":tc.name,Status:tc.status}));
  });
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"TestCases");
  XLSX.writeFile(wb,"portfolio-test-cases.xlsx");
}

/* ---------- RENDER ---------- */
function render(){
  summaryTable.innerHTML="";
  testCaseTable.innerHTML="";
  projectSelect.innerHTML="";

  Object.entries(projects).forEach(([p,t])=>{
    const ps=t.filter(x=>x.status==="passed").length;
    const f=t.filter(x=>x.status==="failed").length;
    const pen=t.filter(x=>x.status==="pending").length;
    const st=projectStatus(t);

    summaryTable.innerHTML+=`
      <tr>
        <td>${p}</td>
        <td>${ps}</td>
        <td>${f}</td>
        <td>${pen}</td>
        <td><span class="status ${st}">${st}</span></td>
        <td><button class="delete" onclick="deleteProject('${p}')">Delete</button></td>
      </tr>`;

    const opt=document.createElement("option");
    opt.value=opt.textContent=p;
    projectSelect.appendChild(opt);

    t.forEach(tc=>{
      testCaseTable.innerHTML+=`
        <tr>
          <td>${p}</td>
          <td>${tc.id}</td>
          <td>${tc.name}</td>
          <td>
            <select onchange="updateTestStatus('${p}',${tc.id},this.value)">
              <option value="pending" ${tc.status==="pending"?"selected":""}>Pending</option>
              <option value="passed" ${tc.status==="passed"?"selected":""}>Passed</option>
              <option value="failed" ${tc.status==="failed"?"selected":""}>Failed</option>
            </select>
          </td>
          <td><button class="delete" onclick="deleteTestCase('${p}',${tc.id})">Delete</button></td>
        </tr>`;
    });
  });
}

render();
</script>
</body>
</html>
